from gpiozero import DistanceSensor
import time
import numpy as np
import warnings

def GetAvgSensorDataOverTime(ObjectArr):
    # Transpose the list of lists
    transposed = zip(*ObjectArr)
    
    # Calculate the average for each index
    AvgObstacleInterference = [int(sum(values) / len(values)) for values in transposed]
    
    return AvgObstacleInterference

def check_obstacle(sensor1_data, sensor2_data, sensor3_data, sensor4_data):
    ObstacleVal = []
    if 35 <= sensor1_data <= 90:
        ObstacleVal.append(1)
    else:
        ObstacleVal.append(0)
    if 35 <= sensor2_data <= 90:
        ObstacleVal.append(1)
    else:
        ObstacleVal.append(0)
    if 35 <= sensor3_data <= 90:
        ObstacleVal.append(1)
    else:
        ObstacleVal.append(0)
    if 10 <= sensor4_data <= 35:
        ObstacleVal.append(1)
    else:
        ObstacleVal.append(0)
    return ObstacleVal

def GetDist(echo, trigger, max_Distance):
    range = DistanceSensor(echo, trigger, max_Distance) #meter distance
    dist = (range.distance) * 39.37 #inches conversion
    return dist

# Define GPIO pins for the sensors
trigger1, echo1 = 17, 18
trigger2, echo2 = 22, 27
trigger3, echo3 = 23, 24
trigger4, echo4 = 8, 25

trigger = [trigger1, trigger2, trigger3, trigger4]
echo = [echo1, echo2, echo3, echo4]

EchoArr = [18, 27, 24, 25]
TrigArr = [17, 22, 23, 8]
ObjectArr = []
maxDistance = 20 #range limit for ultrasonics

# Call the function to read data from all four sensors
while True:
    with warnings.catch_warnings():
        warnings.simplefilter("ignore")
        for j in range(3): # Iterate for 3 scans to get average obstacle avoidance
            time.sleep(0.1)
            sensor_data = [] #temp list to store 4 sensor values
            for i in range(len(EchoArr)): 
                if i == 0:
                    sensor1_data = GetDist(EchoArr[i], trigger[i], maxDistance)
                elif  i == 1:
                    sensor2_data = GetDist(EchoArr[i], trigger[i], maxDistance)
                elif  i == 2:
                    sensor3_data = GetDist(EchoArr[i], trigger[i], maxDistance)
                else:
                    sensor4_data = GetDist(EchoArr[i], trigger[i], maxDistance)
            if j == 0:
                ObsScan1 = check_obstacle(sensor1_data, sensor2_data, sensor3_data, sensor4_data) #gets obstacle avoidance for first scan
                ObjectArr.append(ObsScan1) #stores the first scan for further calculations later
            elif j == 1:
                ObsScan2 = check_obstacle(sensor1_data, sensor2_data, sensor3_data, sensor4_data)  #gets obstacle avoidance for second scan
                ObjectArr.append(ObsScan2) #stores the second scan for further calculations later
            elif j == 2:
                ObsScan3 = check_obstacle(sensor1_data, sensor2_data, sensor3_data, sensor4_data)  #gets obstacle avoidance for third scan
                ObjectArr.append(ObsScan3) #stores the third scan for further calculations later
        
    #print(f"S1: {sensor1_data}, S2: {sensor2_data},  S3: {sensor3_data}, S4: {sensor4_data}")
    OvertimeObstacleInterference_data = GetAvgSensorDataOverTime(ObjectArr)
    print("AvgScan: ", OvertimeObstacleInterference_data)
    print("")
    ObjectArr = [] #clears the objectArr for new scans



